---
description: TCP关闭连接的四次挥手流程是什么?
---

# 四次挥手机制?

## TCP四次挥手关闭连接

![](../../.gitbook/assets/image%20%2818%29.png)

假设客户端主动释放连接。

1. 首先客户端向服务器发送一段 TCP 报文表明其想要释放 TCP 连接，其中：
   * 标记位FIN置为1，表示请求释放连接；
   * 序列号为 Seq = u；
   * 随后客户端进入FIN-WAIT-1阶段，即半关闭阶段，并且停止向服务端发送数据。
2. 服务器接收到FIN报文后，进入 CLOSE-WAIT 阶段并返回一段 TCP 报文，其中：
   * 标记位ACK置为1，表示接收到客户端释放连接的请求；
   * 序列号为 Seq = v；
   * 确认号为 Ack = u + 1，表示收到客户端报文。一个FIN占用一个字节（序号）；
   * 客户端结束 FIN-WAIT-1 阶段，进入 FIN-WAIT-2 阶段。
3. 服务器端在发出 ACK 确认报文后，将遗留的待传数据传送给客户端，待传输完成后即经过 CLOSE-WAIT 阶段，便做好了释放服务器端到客户端的连接准备，再次向客户端发出一段 TCP 报文，其中：
   * 标记位为FIN和ACK置为1，表示已经准备好释放连接了； 
   * 序列号为 Seq = w； 
   * 确认号为 Ack = u + 1，没有更新。
   * 服务器结束 CLOSE-WAIT 阶段，进入 LAST-ACK 阶段，停止向客户端发送数据。
4. 客户端确认了服务器已经做好释放连接的准备，于是结束 FIN-WAIT-2 阶段，进入 TIME-WAIT 阶段，并向服务器发送一段报文，其中：
   * 标记位ACK置为1，表示接收到服务器准备好释放连接的信号；
   * 序号为 Seq= u + 1，表示上一个FIN报文已经成功发出去了；
   * 确认号为 Ack= w + 1，表示收到了服务器的报文。

随后客户端开始在 TIME-WAIT 阶段等待 2 MSL。服务器端收到从客户端发出的 TCP 报文之后结束 LAST-ACK 阶段，进入 CLOSED 阶段。客户端等待完 2 MSL 之后，结束 TIME-WAIT 阶段，进入 CLOSED 阶段，由此完成四次挥手。



